@let room = roomResource.value();
@let messages = messagesResource.value();
<div class="grid grid-cols-1 grid-rows-[auto_1fr_auto] bg-gray-100 h-dvh">
  @if (room) {
    <a routerLink="plan" class="flex items-center gap-x-[10px] p-[15px] pt-[6.5rem] justify-between bg-white">
      <div class="flex items-center gap-x-[10px]">
        <div class="w-[40px] h-[40px] text-center content-center bg-gray-100 rounded-lg text-xl">
          {{ room.plan.emoji }}
        </div>
        <div>
          <b class="text-base text-gray-900 leading-[100%] font-semibold ellipsis">{{
            room.plan.name
          }}</b>
          <p class="block mt-[4px] ellipsis text-sm text-gray-500 leading-[100%]">
            {{ room.plan.datetime | day }} • {{ room.plan.location }}
          </p>
        </div>
      </div>
    </a>
  }
  <section
    class="px-[15px] flex flex-col-reverse overflow-y-auto py-[7.5px] remove-scroll"
    [class.empty-bg]="messages && messages.length === 0"
    #messagesContent
  >
    @if (room) {
      @for (message of messages; track $index) {
        <div class="flex flex-col">
          <p
            class="bg-white/50 py-2 px-3 rounded-full mx-auto backdrop-blur-sm my-[7.5px] block w-fit text-center text-xs text-gray-900 sticky top-0 z-10 leading-[100%]"
          >
            {{ message.date | chatDate }}
          </p>
          <div class="w-full flex flex-col-reverse">
            @for (item of message.messages; track item.id) {
              <div class="py-[7.5px]">
                @defer (on viewport) {
                  <app-message
                    [data]="item"
                    [position]="item.sender_type === 'initiator' ? 'left' : 'right'"
                  ></app-message>
                } @loading {
                  <div class="w-full space-y-[15px]">
                    <div
                      class="w-full max-w-[calc(100%-42px)] h-auto ml-auto flex flex-row-reverse items-start gap-x-2 animate-pulse"
                    >
                      <div class="w-8 h-8 bg-gray-300 rounded-full shrink-0"></div>
                      <div class="flex-1 space-y-2 bg-white p-[10px] rounded-xl">
                        <div class="h-4 ml-auto bg-gray-300 rounded w-3/4"></div>
                        <div class="h-4 ml-auto bg-gray-300 rounded w-1/2"></div>
                      </div>
                    </div>
                    <div
                      class="w-full max-w-[calc(100%-42px)] h-auto flex items-start gap-x-2 animate-pulse"
                    >
                      <div class="w-8 h-8 bg-gray-300 rounded-full shrink-0"></div>
                      <div class="flex-1 space-y-2 bg-white p-[10px] rounded-xl">
                        <div class="h-4 bg-gray-300 rounded w-3/4"></div>
                        <div class="h-4 bg-gray-300 rounded w-1/2"></div>
                      </div>
                    </div>
                  </div>
                } @placeholder {
                  <div class="w-full space-y-[15px]">
                    <div
                      class="w-full max-w-[calc(100%-42px)] h-auto ml-auto flex flex-row-reverse items-start gap-x-2 animate-pulse"
                    >
                      <div class="w-8 h-8 bg-gray-300 rounded-full shrink-0"></div>
                      <div class="flex-1 space-y-2 bg-white p-[10px] rounded-xl">
                        <div class="h-4 ml-auto bg-gray-300 rounded w-3/4"></div>
                        <div class="h-4 ml-auto bg-gray-300 rounded w-1/2"></div>
                      </div>
                    </div>
                    <div
                      class="w-full max-w-[calc(100%-42px)] h-auto flex items-start gap-x-2 animate-pulse"
                    >
                      <div class="w-8 h-8 bg-gray-300 rounded-full shrink-0"></div>
                      <div class="flex-1 space-y-2 bg-white p-[10px] rounded-xl">
                        <div class="h-4 bg-gray-300 rounded w-3/4"></div>
                        <div class="h-4 bg-gray-300 rounded w-1/2"></div>
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
    }
  </section>
  <div class="flex items-end gap-x-[10px] bg-white p-[10px] rounded-t-xl">
    <label
      class="flex-1 ring-1 p-[10px] inline-flex ring-[#E9ECEF] rounded-lg w-full h-auto transition-all duration-200 focus-within:ring-[#FA709A]"
      for="msg"
    >
      <textarea
        [(ngModel)]="message"
        matInput
        id="msg"
        cdkTextareaAutosize
        #autosize="cdkTextareaAutosize"
        cdkAutosizeMinRows="1"
        placeholder="Написать сообщение..."
        cdkAutosizeMaxRows="5"
        class="w-full min-h-[30px] resize-none text-base outline-none placeholder:text-black/50 bg-transparent"
      ></textarea>
    </label>
    <button
      [disabled]="!message.trim().length"
      (click)="sendMessage()"
      type="button"
      class="flex-none cursor-pointer rounded-xl w-[50px] h-[50px] shrink-[0] content-center text-center leading-1 bg-[linear-gradient(135deg,#FA709A_0%,#FEE140_100%)]"
      [class.opacity-50]="!message.trim().length"
    >
      <img src="svg/send.svg" alt="send.svg" width="25" height="25" class="block mx-auto" />
    </button>
  </div>
</div>
